# -*- coding: utf-8 -*-
"""7.paper_review.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1p_j63avOGE1m7hNbMW8WRTC4cd-axI_3
"""

!pip install langchain langchain-core langchain-community
!pip install pypdf
!pip install openai
!pip install tiktoken

import os
os.environ["OPENAI_API_KEY"] = "{YOUR_API_KEY}"
os.environ["AZURE_OPENAI_ENDPOINT"] = "YOUR_API_ENDPOINT"
os.environ["OPENAI_API_TYPE"] = "{YOUR_API_TYPE}"
os.environ["OPENAI_API_VERSION"] = "{YOUR_API_VERSION}"

from langchain.document_loaders import PyPDFLoader
from langchain.text_splitter import RecursiveCharacterTextSplitter
from openai import AzureOpenAI
import tiktoken

# PDF ë¶ˆëŸ¬ì˜¤ê¸°
loader = PyPDFLoader("/content/NetLLM.pdf")
pages = loader.load_and_split()
pages

# í† í° ë‹¨ìœ„ë¡œ ì˜ë¼ì£¼ê¸° ì‘ì—…ì„ í•˜ê¸° ìœ„í•´ í† í¬ë‚˜ì´ì € ìƒì„±
tokenizer = tiktoken.encoding_for_model("gpt-4o-mini")
def tiktoken_len(text):
  tokens = tokenizer.encode(text)
  return len(tokens)

# ë¬¸ì„œë¥¼ í† í° ë‹¨ìœ„ë¡œ split
text_spliiter = RecursiveCharacterTextSplitter(
    chunk_size = 500,
    chunk_overlap = 20,
    length_function = tiktoken_len,
)

docs = text_spliiter.split_documents(pages)

from langchain.chat_models import AzureChatOpenAI
from langchain.chains import LLMChain
from langchain.prompts import PromptTemplate

def build_review_chain():
    template = """
    ë„ˆëŠ” ë…¼ë¬¸ ë¦¬ë·°ì–´ì•¼. ë‹¤ìŒ ë…¼ë¬¸ ë‚´ìš©ì„ ë³´ê³  ì•„ë˜ë¥¼ ìˆ˜í–‰í•´ì¤˜:

    1. ì—°êµ¬ ëª©ì ì„ ê°„ê²°í•˜ê²Œ ìš”ì•½í•´ì¤˜.
    2. ê°•ì ê³¼ í•œê³„ì ì„ bullet pointë¡œ ì •ë¦¬í•´ì¤˜.
    3. ë‹¤ìŒ í•­ëª©ë³„ë¡œ 5ì  ë§Œì  ê¸°ì¤€ìœ¼ë¡œ ì ìˆ˜ë¥¼ ë§¤ê²¨ì¤˜:
       - í˜ì‹ ì„±
       - ë…¼ë¦¬ì„±
       - ì‹¤ìš©ì„±

    ë…¼ë¬¸ ë‚´ìš©:
    {context}

    ì¶œë ¥ í˜•ì‹:
    [ìš”ì•½]
    ...

    [ê°•ì ]
    - ...

    [í•œê³„ì ]
    - ...

    [í‰ì ]
    - í˜ì‹ ì„±: ? / 5
    - ë…¼ë¦¬ì„±: ? / 5
    - ì‹¤ìš©ì„±: ? / 5
    """

    prompt = PromptTemplate(
        input_variables=["context"],
        template=template,
    )

    llm = AzureChatOpenAI(
    model_name="dev-gpt-4o-mini",
    temperature=0.4,
    max_tokens=500
)


    chain = LLMChain(llm=llm, prompt=prompt)
    return chain

chain = build_review_chain()

# ì²˜ìŒ 2ê°œ chunkë§Œ ì‚¬ìš© (ì†ë„ ë¬¸ì œ ë°©ì§€)
context = docs
review = chain.run(context)

from IPython.display import Markdown
Markdown(f"### ğŸ“ ë¦¬ë·° ê²°ê³¼\n\n```\n{review}\n```")
